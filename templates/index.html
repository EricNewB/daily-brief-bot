<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Brief Bot - 测试面板</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Daily Brief Bot 测试面板</h1>
        
        <!-- 控制面板 -->
        <div class="bg-white shadow rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">控制面板</h2>
            <div class="space-y-4">
                <!-- 内容抓取测试 -->
                <div>
                    <h3 class="text-lg font-medium mb-2">内容抓取测试</h3>
                    <div class="space-x-4">
                        <button onclick="fetchContent('hacker-news')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            测试 HackerNews
                        </button>
                        <button onclick="fetchContent('weibo')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            测试微博热搜
                        </button>
                        <button onclick="fetchContent('all')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                            测试全部来源
                        </button>
                    </div>
                </div>

                <!-- 邮件测试 -->
                <div>
                    <h3 class="text-lg font-medium mb-2">邮件发送测试</h3>
                    <div class="space-x-4">
                        <button onclick="testEmail()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                            测试邮件发送
                        </button>
                    </div>
                </div>
                
                <!-- 内容筛选测试 -->
                <div>
                    <h3 class="text-lg font-medium mb-2">内容筛选测试</h3>
                    <div class="space-x-4">
                        <button onclick="filterContent()" id="filter-btn" disabled class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            AI智能筛选
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志输出 -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                <span>日志输出</span>
                <div class="space-x-2">
                    <button onclick="clearLog()" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">
                        清除日志
                    </button>
                    <button onclick="copyLog()" class="text-sm bg-green-200 hover:bg-green-300 px-3 py-1 rounded">
                        复制日志
                    </button>
                </div>
            </h2>
            <pre id="log-output" class="bg-gray-100 p-4 rounded max-h-96 overflow-y-auto font-mono text-sm whitespace-pre-wrap"></pre>
        </div>
    </div>

    <script>
        let accumulatedContent = {
            'HackerNews': [],
            'Weibo': [],
            'WeChat': []
        };

        function appendLog(message) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function copyLog() {
            const logOutput = document.getElementById('log-output');
            navigator.clipboard.writeText(logOutput.textContent).then(() => {
                appendLog('日志已复制到剪贴板');
            }).catch(err => {
                appendLog(`复制失败: ${err}`);
            });
        }

        async function fetchContent(source) {
            try {
                appendLog(`开始获取${source}内容...`);
                const response = await axios.get(`/test/${source}`);
                if (response.data.log) {
                    appendLog('调试日志:');
                    appendLog(response.data.log);
                }
                if (response.data.success) {
                    if (source === 'all') {
                        // 处理所有来源的数据
                        const allData = response.data.data;
                        for (const [src, items] of Object.entries(allData)) {
                            const normalizedSource = src === 'hacker-news' ? 'HackerNews' : 
                                                   src === 'weibo' ? 'Weibo' : 
                                                   src === 'wechat' ? 'WeChat' : src;
                            accumulatedContent[normalizedSource] = items.map(item => ({...item, source: normalizedSource}));
                        }
                    } else {
                        // 处理单个来源的数据
                        const normalizedSource = source === 'hacker-news' ? 'HackerNews' : 
                                               source === 'weibo' ? 'Weibo' : 
                                               source === 'wechat' ? 'WeChat' : source;
                        accumulatedContent[normalizedSource] = response.data.data.map(item => ({...item, source: normalizedSource}));
                    }
                    
                    const filterBtn = document.getElementById('filter-btn');
                    if (filterBtn) {
                        filterBtn.disabled = false;
                    }
                    appendLog(`获取成功！数据：`);
                    appendLog(JSON.stringify(response.data.data, null, 2));
                    
                    // 显示累积的内容统计
                    const stats = {};
                    for (const [src, items] of Object.entries(accumulatedContent)) {
                        if (items.length > 0) {
                            stats[src] = items.length;
                        }
                    }
                    appendLog(`当前累积的内容：${JSON.stringify(stats, null, 2)}`);
                } else {
                    appendLog(`获取失败：${response.data.error || '未知错误'}`);
                }
            } catch (error) {
                appendLog(`错误: ${error.message}`);
                if (error.response && error.response.data) {
                    appendLog(`详细错误: ${JSON.stringify(error.response.data, null, 2)}`);
                }
            }
        }

        async function filterContent() {
            const allContent = Object.values(accumulatedContent).flat();
            if (allContent.length === 0) {
                appendLog('没有可供筛选的内容，请先获取内容！');
                return;
            }
            
            try {
                appendLog('开始AI智能筛选...');
                const filterBtn = document.getElementById('filter-btn');
                if (filterBtn) {
                    filterBtn.disabled = true;
                }
                
                const response = await axios.post('/filter', {
                    content: accumulatedContent
                });
                
                if (response.data.success) {
                    appendLog('筛选成功！筛选后的内容：');
                    appendLog(JSON.stringify(response.data.data, null, 2));
                    
                    // 显示调试信息
                    if (response.data.debug) {
                        appendLog('筛选调试信息：');
                        appendLog(JSON.stringify(response.data.debug, null, 2));
                    }
                } else {
                    appendLog(`筛选失败：${response.data.error || '未知错误'}`);
                    
                    // 显示调试信息
                    if (response.data.debug) {
                        appendLog('筛选调试信息：');
                        appendLog(JSON.stringify(response.data.debug, null, 2));
                    }
                }
                
                if (filterBtn) {
                    filterBtn.disabled = false;
                }
            } catch (error) {
                appendLog(`错误: ${error.message}`);
                if (error.response && error.response.data) {
                    appendLog(`详细错误: ${JSON.stringify(error.response.data, null, 2)}`);
                }
                const filterBtn = document.getElementById('filter-btn');
                if (filterBtn) {
                    filterBtn.disabled = false;
                }
            }
        }

        async function testEmail() {
            try {
                appendLog('开始测试邮件发送...');
                const response = await axios.get('/test/email');
                if (response.data.log) {
                    appendLog('调试日志:');
                    appendLog(response.data.log);
                }
                appendLog(`邮件发送结果: ${JSON.stringify(response.data, null, 2)}`);
            } catch (error) {
                appendLog(`错误: ${error.message}`);
                if (error.response && error.response.data) {
                    appendLog(`详细错误: ${JSON.stringify(error.response.data, null, 2)}`);
                }
            }
        }

        function clearLog() {
            const logOutput = document.getElementById('log-output');
            logOutput.innerHTML = '';
            // 同时清除累积的内容
            accumulatedContent = {
                'HackerNews': [],
                'Weibo': [],
                'WeChat': []
            };
        }
    </script>
</body>
</html>